<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="UTF-8"/><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><link rel="apple-touch-icon" sizes="180x180" href="..\images\apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="..\images\favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="..\images\favicon-16x16.png"/><link rel="manifest" href="..\images\manifest.json"/><link rel="mask-icon" href="..\images\safari-pinned-tab.svg" color="#5bbad5"/><meta name="theme-color" content="#ffffff"/><meta http-equiv="Cache-Control" content="no-transform"/><meta http-equiv="Cache-Control" content="no-siteapp"/><title>安全鉴权-文档</title><link rel="stylesheet" href="..\ydoc\styles\style.css"/><meta name="author" content="roc.long"/><meta name="keywords"/><meta name="description" content="MVCXE | 中国首个DELPHI MVC WEB框架"/><meta id="releativePath" content=".."/><link rel="stylesheet" href="..\ydoc\ydoc-plugin-search\search.css"/></head><body><div class="g-doc"><div class="m-aside"><div class="m-summary" id="js-menu"><div class="m-summary-content" id="js-menu-content"><div class="m-summary-block"><ul class="m-summary-list"><li class="item"><a href="installation.html" class="href">一分钟上手</a></li></ul></div><div class="m-summary-block"><div class="m-summary-title">开始使用</div><ul class="m-summary-list indent"><li class="item"><a href="intro.html#" class="href">介绍</a></li></ul></div><div class="m-summary-block"><div class="m-summary-title">Web服务</div><ul class="m-summary-list indent"><li class="item"><a href="appstartup.html" class="href">应用启动 Startup</a></li><li class="item"><a href="configuration.html" class="href">配置</a></li><li class="item"><a href="options.html" class="href">选项</a></li></ul></div><div class="m-summary-block"><div class="m-summary-title">Web应用开发</div><ul class="m-summary-list indent"><li class="item"><a href="dynamic-api-controller.html" class="href">动态 WebAPI</a></li><li class="item"><a href="httpcontext.html" class="href">HttpContext</a></li><li class="item"><a href="sesssion-state.html" class="href">会话和状态管理</a></li><li class="item"><a href="cache.html" class="href">缓存</a></li><li class="item"><a href="" class="href">安全鉴权</a></li><li class="item"><a href="cors.html" class="href">CORS 跨域</a></li><li class="item"><a href="view-engine.html" class="href">视图引擎</a></li><li class="item"><a href="action-result.html" class="href">统一返回</a></li><li class="item"><a href="logging.html" class="href">日志记录</a></li><li class="item"><a href="json-serialization.html" class="href">JSON 序列化</a></li><li class="item"><a href="xml-serialization.html" class="href">XML 序列化</a></li><li class="item"><a href="idgenerator.html" class="href">分布式 ID 生成</a></li><li class="item"><a href="upload-download.html" class="href">文件上传下载</a></li></ul></div><div class="m-summary-block"><div class="m-summary-title">对象容器模块</div><ul class="m-summary-list indent"><li class="item"><a href="dependency-injection.html" class="href">依赖注入/控制反转</a></li><li class="item"><a href="object-mapper.html" class="href">对象数据映射</a></li><li class="item"><a href="module-dev.html" class="href">模块化开发</a></li></ul></div><div class="m-summary-block"><div class="m-summary-title">规范化接口文档</div><ul class="m-summary-list indent"><li class="item"><a href="specification-document.html" class="href">Swagger</a></li></ul></div><div class="m-summary-block"><div class="m-summary-title">异常与审计处理</div><ul class="m-summary-list indent"><li class="item"><a href="friendly-exception.html" class="href">友好异常处理</a></li></ul></div><div class="m-summary-block"><div class="m-summary-title">数据库操作指南</div><ul class="m-summary-list indent"><li class="item"><a href="dbcontext-start.html" class="href">入门简要</a></li><li class="item"><a href="dbcontext.html" class="href">数据库上下文</a></li><li class="item"><a href="entity.html" class="href">数据库实体</a></li><li class="item"><a href="dbcontext-repository.html" class="href">仓储模式</a></li><li class="item"><a href="dbcontext-db.html" class="href">Sql操作模式</a></li><li class="item"><a href="dbcontext-add.html" class="href">新增操作</a></li><li class="item"><a href="dbcontext-update.html" class="href">更新操作</a></li><li class="item"><a href="dbcontext-delete.html" class="href">删除操作</a></li><li class="item"><a href="dbcontext-query.html" class="href">查询操作</a></li><li class="item"><a href="dbcontext-hight-query.html" class="href">高级查询操作</a></li><li class="item"><a href="dbcontext-proc.html" class="href">存储过程操作</a></li><li class="item"><a href="dbcontext-function.html" class="href">函数操作</a></li><li class="item"><a href="tran.html" class="href">事务</a></li></ul></div><div class="m-summary-block"><div class="m-summary-title">定时任务 (Schedule)</div><ul class="m-summary-list indent"><li class="item"><a href="job.html" class="href">调度作业</a></li><li class="item"><a href="cron.html" class="href">Cron 表达式</a></li></ul></div></div></div><div class="m-summary-switch" id="js-summary-switch"><svg viewBox="0 0 926.23699 573.74994" version="1.1" x="0px" y="0px" width="15" height="15" class="bottom"><g transform="translate(904.92214,-879.1482)"><path d="m -673.67664,1221.6502 -231.2455,-231.24803 55.6165,-55.627 c 30.5891,-30.59485 56.1806,-55.627 56.8701,-55.627 0.6894,0 79.8637,78.60862 175.9427,174.68583 l 174.6892,174.6858 174.6892,-174.6858 c 96.079,-96.07721 175.253196,-174.68583 175.942696,-174.68583 0.6895,0 26.281,25.03215 56.8701,55.627 l 55.6165,55.627 -231.245496,231.24803 c -127.185,127.1864-231.5279,231.248 -231.873,231.248 -0.3451,0 -104.688,-104.0616 -231.873,-231.248 z" fill="#fff"></path></g></svg><svg viewBox="0 0 926.23699 573.74994" version="1.1" x="0px" y="0px" width="15" height="15" class="top"><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="aaa" fill="#fff" fill-rule="nonzero"><path d="M231.2455,342.502 L0,111.25397 L55.6165,55.62697 C86.2056,25.03212 111.7971,-2.99999998e-05 112.4866,-2.99999998e-05 C113.176,-2.99999998e-05 192.3503,78.60859 288.4293,174.6858 L463.1185,349.3716 L637.8077,174.6858 C733.8867,78.60859 813.060896,-2.99999997e-05 813.750396,-2.99999997e-05 C814.439896,-2.99999997e-05 840.031396,25.03212 870.620496,55.62697 L926.236996,111.25397 L694.9915,342.502 C567.8065,469.6884 463.4636,573.75 463.1185,573.75 C462.7734,573.75 358.4305,469.6884 231.2455,342.502 Z" id="Shape" transform="translate(463.118498, 286.874985) scale(1, -1) translate(-463.118498, -286.874985) "></path></g></g></svg></div></div><div class="m-main" id="js-panel"><header class="m-header" id="js-header"><div class="m-header-title js-logo"><a href="..\index.html" target="_self"><img class="logo" width="36" src="..\images\logo.png"/><h6 class="name">MVCXE</h6></a></div><div><div class="m-search">
      <div class="icon">&#xf0fd;</div>
      <input type="text" class="input js-input" placeholder="搜索" />
      <div class="m-search-result js-search-result"></div>
    </div></div><nav class="m-header-nav js-nav"><ul class="m-header-items"><li class="item active"><a class="href" href="index.html">文档</a></li><li class="item "><a class="href" href="..\about\index.html">关于</a></li></ul></nav><div id="js-nav-btn" class="m-header-btn ui-font-ydoc"></div></header><div class="m-content" id="js-content"><div id="markdown-body" class="m-content-container markdown-body"><h1>安全鉴权</h1>
<h2 id="什么是鉴权">什么是鉴权</h2>
<p>鉴权实际上就是一种身份认证。</p>
<p>由用户提供凭据，然后将其与存储在操作系统、数据库、应用或资源中的凭据进行比较。 在授权过程中，如果凭据匹配，则用户身份验证成功，可执行已向其授权的操作。 授权指判断允许用户执行的操作的过程。 也可以将身份验证理解为进入空间（例如服务器、数据库、应用或资源）的一种方式，而授权是用户可以对该空间（服务器、数据库或应用）内的哪些对象执行哪些操作。</p>
<p>常见的鉴权方式</p>
<ul>
<li>HTTP Basic Authentication</li>
</ul>
<p>这是 HTTP 协议实现的基本认证方式，我们在浏览网页时，从浏览器正上方弹出的对话框要求我们输入账号密码，正是使用了这种认证方式</p>
<ul>
<li>Session + Cookie</li>
</ul>
<p>利用服务器端的 session（会话）和浏览器端的 cookie 来实现前后端的认证，由于 http 请求时是无状态的，服务器正常情况下是不知道当前请求之前有没有来过，这个时候我们如果要记录状态，就需要在服务器端创建一个会话(session),将同一个客户端的请求都维护在各自的会话中，每当请求到达服务器端的时候，先去查一下该客户端有没有在服务器端创建 session，如果有则已经认证成功了，否则就没有认证。</p>
<ul>
<li>Token</li>
</ul>
<p>客户端在首次登录以后，服务端再次接收 HTTP 请求的时候，就只认 Token 了，请求只要每次把 Token 带上就行了，服务器端会拦截所有的请求，然后校验 Token 的合法性，合法就放行，不合法就返回 401（鉴权失败）</p>
<p>Token验证比较灵活，适用于大部分场景。常用的 Token 鉴权方式的解决方案是 JWT，JWT 是通过对带有相关用户信息的进行加密，加密的方式比较灵活，可以根据需求具体设计。</p>
<ul>
<li>OAuth</li>
</ul>
<p>OAuth（开放授权）是一个开放标准，允许用户授权第三方网站访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方网站或分享他们数据的所有内容，为了保护用户数据的安全和隐私，第三方网站访问用户数据前都需要显式的向用户征求授权。我们常见的提供 OAuth 认证服务的厂商有支付宝、QQ 和微信。</p>
<p>OAuth 协议又有 1.0 和 2.0 两个版本。相比较 1.0 版，2.0 版整个授权验证流程更简单更安全，也是目前最主要的用户身份验证和授权方式。</p>
<h2 id="如何使用">如何使用</h2>
<pre><code>uses
  MVCXE.Authorization;
</code></pre>
<blockquote>
<p>默认的身份结构包括名字字符串，是否已认证通过，角色字符串，认证类型。</p>
</blockquote>
<pre><code>TIdentity = record
    Name: string;
    IsAuthenticated: Boolean;
    Roles: string;
    AuthenticationType: string;
end;
</code></pre>
<blockquote>
<p>注入<code>IHttpContextAccessor</code>使用<a href="httpcontext.html">HttpContext</a>里定义的<code>User</code>方法获取包含TIdentity的接口<code>IPrincipal</code></p>
</blockquote>
<pre><code>IPrincipal = interface
  ['{952A2782-CE55-41C0-A155-35080914FEAA}']
  function GetIdentity: TIdentity;
  procedure SetIdentity(Value: TIdentity);
  property Identity: TIdentity read GetIdentity write SetIdentity;
  function IsInRole(const role: string): Boolean;
  procedure UpdateFormsAuthenticationTicket(Response: TMVCXEResponse; const Expires: TDateTime);
  procedure RemoveFormsAuthenticationTicket(Response: TMVCXEResponse);
end;

THttpContext = class
public
  function User: IPrincipal; overload;
end;
</code></pre>
<blockquote>
<p>例子, 我们将登陆信息存储在TIdentity.Name中，格式是：<code>用户名$用户id$用户Email$是否登陆</code></p>
</blockquote>
<pre><code>type
  BaseController = class(TController)
  private
  protected
    [IOC('MVCXE.HttpContext.THttpContextAccessor')]
    accessor: IHttpContextAccessor;
    function IsLogin: Boolean;
    function CurrentAccount: String;
    function CurrentUserId: Integer;
    function EmailConfirmed: Boolean;
    function IsAdmin: Boolean;
  public
  end;

implementation

uses
  Fly.Authorization;

{ BaseController }

function BaseController.CurrentAccount: String;
var
  name: string;
begin
  if not IsLogin then
    Result := nil
  else
  begin
    name := accessor.HttpContext.User.Identity.name;
    Result := name.Split(['$'])[0];
  end;
end;

function BaseController.CurrentUserId: Integer;
var
  name: string;
begin
  if not IsLogin then
    Result := -1
  else
  begin
    name := accessor.HttpContext.User.Identity.name;
    Result := StrToInt(name.Split(['$'])[1]);
  end;
end;

function BaseController.EmailConfirmed: Boolean;
var
  name: string;
begin
  if not IsLogin then
    Result := False
  else
  begin
    name := accessor.HttpContext.User.Identity.name;
    Result := StrToBool(name.Split(['$'])[2]);
  end;
end;

function BaseController.IsAdmin: Boolean;
begin
  Result := accessor.HttpContext.User.IsInRole('admin');
end;

function BaseController.IsLogin: Boolean;
begin
  Result := accessor.HttpContext.User.Identity.IsAuthenticated;
end;
</code></pre>
<blockquote>
<p>登陆代码</p>
</blockquote>
<pre><code>function TAccountController.check(const email, pass, vercode: string)
  : TAccountFormResult;
var
  User: TUsers;
  HashMD5: THashMD5;
  s: string;
  Membership: TIdentity;
begin
  Response.ContentType := 'application/json';
  Result.success := False;
  s := accessor.HttpContext.Session.Get&lt;string&gt;('ValidationCode');
  if not SameText(vercode, s) then
  begin
    Result.msg := '验证码不正确.';
    Exit;
  end;
  User := UserService.GetUser(email);
  if User = nil then
  begin
    Result.msg := '找不到用户.';
    Exit;
  end;
  HashMD5 := THashMD5.Create;
  s := HashMD5.GetHashString(pass);
  if not SameText(User.Password, s) then
  begin
    Result.msg := '密码不正确.';
    Exit;
  end;
  Membership.Name := User.Email + '$' + IntToStr(User.Id) + '$' + BoolToStr(User.EmailConfirmed) + '$' + BoolToStr(User.IsAdmin);
  Membership.IsAuthenticated := True;
  if User.IsAdmin then
    Membership.Roles := 'admin,';
  accessor.HttpContext.User.Identity := Membership;
  accessor.HttpContext.User.UpdateFormsAuthenticationTicket(Response, Now+30);

  Result.msg := '登陆成功.';
  User.Password := '';
  Result.user := User;
  Result.success := True;
end;
</code></pre>
<h2 id="自定身份验证类">自定身份验证类</h2>
<blockquote>
<p>自定我们的身份验证类TMyPrincipal</p>
</blockquote>
<pre><code>uses
  System.Classes, System.SysUtils, MVCXE.HTTPApp, MVCXE.HttpContext,
  Fly.Model.Users;

type
  TMyPrincipal = class(BasePrincipal)
  const SecretKey = 'Fly.Authorization';
  const CookieKey = 'Fly.Authorization';
  private
    FAuthorization: string;
    FIdentity: TUsers;
    procedure TrySetUserInfo;
    function FormsAuthenticationTicket: string;
  public
    function Identity: TUsers;
    function IsInRole(const role: string): Boolean;
    procedure SignIn(const User: TUsers);
    procedure UpdateFormsAuthenticationTicket(Response: TMVCXEResponse; const Expires: TDateTime);
    procedure RemoveFormsAuthenticationTicket(Response: TMVCXEResponse);
  end;
</code></pre>
<blockquote>
<p>TMyPrincipal中Identity是获取身份的方法，它一般返回用户表的实体类，也可以自定义，其它辅助方法可以自由添加。</p>
</blockquote>
<pre><code>uses
  MVCXE.JWT;

{ TMyPrincipal }

function TMyPrincipal.FormsAuthenticationTicket: string;
var
  JwtBearer: TJwtBearer;
begin
  JwtBearer := TJwtBearer.Create;
  JwtBearer.SecretKey := SecretKey;
  JwtBearer.Algorithm := TJWTAlgorithm.HS256;
  JwtBearer.Subject := 'Fly Authentication Ticket';
  JwtBearer.Audience := 'Fly';
  JwtBearer.AddClaim('MemberShip', Identity);
  Result := JwtBearer.Token;
end;

procedure TMyPrincipal.TrySetUserInfo;
var
  JwtBearer: TJwtBearer;
begin
  //演示用cookie来记录登陆状态，也可以用session
  if HttpContext.Request.Cookies.ContainsKey(CookieKey) then
    FAuthorization := HttpContext.Request.Cookies[CookieKey];
  if FAuthorization&lt;&gt;'' then
  begin
    try
      JwtBearer := TJwtBearer.Create(FAuthorization,SecretKey);
      FIdentity := JwtBearer.GetClaim&lt;TUsers&gt;('MemberShip');
    except
    end;
    if Assigned(JwtBearer) then
      FreeAndNil(JwtBearer);
  end;
end;

procedure TMyPrincipal.UpdateFormsAuthenticationTicket(Response: TMVCXEResponse;
  const Expires: TDateTime);
begin
  Response.AddCookie(CookieKey, FormsAuthenticationTicket, Expires);
end;

procedure TMyPrincipal.RemoveFormsAuthenticationTicket(
  Response: TMVCXEResponse);
begin
  Response.AddCookie(CookieKey, '', 0);
end;

function TMyPrincipal.Identity: TUsers;
begin
  if not Assigned(FIdentity) then
  begin
    TrySetUserInfo;
  end;
  Result := FIdentity;
end;

function TMyPrincipal.IsInRole(const role: string): Boolean;
begin
  Result := False;
  if Not Assigned(FIdentity) then
    FIdentity := Identity;
  if Assigned(FIdentity) and (FIdentity.Id&gt;0) then
  begin
    if role='admin' then
      Result := FIdentity.IsAdmin;
  end;
end;

procedure TMyPrincipal.SignIn(const User: TUsers);
begin
  FIdentity := User;
end;
</code></pre>
<blockquote>
<p>上面的例子，使用cookie记录了一个身份信息的JWT token字符串，如果不使用cookie也可以用Session记录，也可以用HttpHeader的Authorization来记录。</p>
</blockquote>
<blockquote>
<p>使用<code>accessor.HttpContext.User&lt;TMyPrincipal&gt;</code>获取我们自定的身份验证类TMyPrincipal</p>
</blockquote>
<pre><code>function TAccountController.check(const email, pass, vercode: string)
  : TAccountFormResult;
var
  User: TUsers;
  HashMD5: THashMD5;
  s: string;
begin
  Response.ContentType := 'application/json';
  Result.success := False;
  s := accessor.HttpContext.Session.Get&lt;string&gt;('ValidationCode');
  if not SameText(vercode, s) then
  begin
    Result.msg := '验证码不正确.';
    Exit;
  end;
  User := UserService.GetUser(email);
  if User = nil then
  begin
    Result.msg := '找不到用户.';
    Exit;
  end;
  HashMD5 := THashMD5.Create;
  s := HashMD5.GetHashString(pass);
  if not SameText(User.Password, s) then
  begin
    Result.msg := '密码不正确.';
    Exit;
  end;

  with accessor.HttpContext.User&lt;TMyPrincipal&gt; do
  begin
    SignIn(User);
    UpdateFormsAuthenticationTicket(Response, Now+30);
  end;

  Result.msg := '登陆成功.';
  User.Password := '';
  Result.user := User;
  Result.success := True;
end;
</code></pre>
<h2 id="webapi验证">WebApi验证</h2>
<blockquote>
<p>创建我们的验证类</p>
</blockquote>
<pre><code>type
  TFerryAuthorization = class(TAuthorization)
  private
    [IOC('MVCXE.HttpContext.THttpContextAccessor')]
    accessor: IHttpContextAccessor;
  published
  public
    procedure OnAuthorization; override;
  end;
implementation
{ TFerryAuthorization }

procedure TFerryAuthorization.OnAuthorization;
begin
  inherited;
  isAuth := True;
  if AuthorizeParam = 'dashboard' then
  begin
    if not accessor.HttpContext.User&lt;TFerryPrincipal&gt;.IsAuthenticated then
    begin
      isAuth := False;
      Response.Content := '{&quot;code&quot;:401,&quot;msg&quot;:&quot;cookie token is empty&quot;}';
    end;
  end
  else if AuthorizeParam = 'index' then
  begin
    if not accessor.HttpContext.User&lt;TFerryPrincipal&gt;.IsAuthenticated then
    begin
      isAuth := False;
      Response.StatusCode := 403;
      Exit;
    end;
  end
  else if AuthorizeParam = 'admin' then
  begin
    if not accessor.HttpContext.User&lt;TFerryPrincipal&gt;.IsAuthenticated then
    begin
      isAuth := False;
      Response.StatusCode := 403;
      Exit;
    end;
  end;
end;
</code></pre>
<blockquote>
<p>在WebApi中用<code>[Authorize]</code>标记该Api或某方法使用我们定义的验证类，当访问这些Api的时候，<code>MVCXE</code>框架会先触发我们定义的验证类的OnAuthorization，如果验证不通过，返回Response的StatusCode并结束这次处理。</p>
</blockquote>
<pre><code>type
  TsysUserWebApi = class(BackendBaseWebApi)
  private
    [IOC]
    SysService: ISysService;
  public
    constructor Create;
    [Authorize('Ferry.Authorization.TFerryAuthorization', 'dashboard')]
    function GET: TSysUserResult;
    [Authorize('Ferry.Authorization.TFerryAuthorization', 'dashboard')]
    function POST([FormBody]user: TSysUser): TSysUserResult;
  end;
implementation
function TsysUserWebApi.GET: TSysUserResult;
begin
  Result.code := 200;
  Result.data.posts := SysService.Posts;
  Result.data.roles := SysService.Roles;
  Result.msg := '';
end;

function TsysUserWebApi.POST(user: TSysUser): TSysUserResult;
begin
  Result.code := 200;
  if SysService.UserByName(user.username).user_id&gt;0 then
  begin
    Result.code := -1;
    Result.msg := '账户已存在！';
    Exit;
  end;
  user.create_by := IntToStr(current_user.user_id);
  user.update_by := IntToStr(current_user.user_id);
  user.create_time := Now;
  user.password := THashMD5.GetHashString(user.password);
  try
  if SysService.SaveUser(user)&lt;1 then
  begin
    Result.code := -1;
    Result.msg := '保存失败！';
    Exit;
  end;
  except
    on e:Exception do
    begin
      Result.code := -1;
      Result.msg := '保存失败！'+e.Message;
      Exit;
    end;
  end;
  Result.msg := '保存成功！';
end;</code></pre>
</div><div class="m-content-container m-paging"><div class="m-paging-prev m-paging-item"><a href="cache.html" class="href"><span class="ui-font-ydoc"></span>缓存</a></div><div class="m-paging-next m-paging-item"><a href="cors.html" class="href">CORS 跨域<span class="ui-font-ydoc"></span></a></div></div></div></div></div><div></div><script>
    var $content = document.getElementById('js-content');
    var $summaryItems = Array.prototype.slice.call(document.querySelectorAll('#js-menu .href'));
    var $menu = document.getElementById('js-menu');
    if ($menu && sessionStorage.menuScrollTop) {
		$menu.scrollTop = sessionStorage.menuScrollTop;
    }
    // 刷新页面但不切换 pathname 的时候，内容区恢复到记忆的高度
    if ($content && sessionStorage.contentScrollTop && window.location.pathname == sessionStorage.locationPathname) {
      $content.scrollTop = sessionStorage.contentScrollTop;
    }
    sessionStorage.setItem('locationPathname', window.location.pathname);</script><script src="..\ydoc\scripts\plugins\dollar.min.js"></script><script src="..\ydoc\scripts\plugins\responsive-nav.min.js"></script><script src="..\ydoc\scripts\plugins\slideout.min.js"></script><script src="..\ydoc\scripts\app.js"></script><script src="..\ydoc\ydoc-plugin-search\core.js"></script><script src="..\ydoc\ydoc-plugin-search\search.js"></script><script src="..\search_json.js"></script></body></html>